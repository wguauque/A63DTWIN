<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>A63 Digital Twin - 3D Model</title>
    
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <link href="main.css" rel="stylesheet">
    
    <style>
        body {
            overflow: hidden; /* Prevent scrolling on the 3D view page */
        }
        #cesiumContainer {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }
        #loadingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(30, 30, 30, 0.97);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: #ffffff; text-align: center;
            transition: opacity 0.5s ease-out;
        }
        #loadingOverlay h1 { font-size: 1.6em; margin-top: 10px; font-weight: 300; }
        .cesium-widget-credits { display: none !important; }

        /* Style adjustments for the combined control panel */
        #controlsDiv .control-group {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        #controlsDiv .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        #controlsDiv h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        #controlsDiv .input-row {
            display: flex;
            gap: 10px;
        }
        #controlsDiv button {
            width: 100%;
            padding: 0.6rem;
            margin-top: 0.5rem;
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #controlsDiv button:hover {
            background-color: #e2e8f0;
        }
        #controlsDiv .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border: none;
        }
    </style>
</head>
<body>

    <header class="main-header">
        <a href="index.html" class="header-brand">
            <img src="atlandes.jpg" alt="Atlandes Logo">
            <span>A63 Digital Twin</span>
        </a>
        <nav class="main-nav">
            <a href="index.html">Home</a>
            <a href="cesium.html" class="active">3D Model</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="map.html">ArcGIS Map</a>
        </nav>
    </header>

    <div id="cesiumContainer"></div>

    <div id="loadingOverlay">
        <h1>Loading Digital Twin Environment...</h1>
    </div>

    <div id="controlsDiv">
        <div class="control-group">
            <h3>Layer Filters</h3>
            <label for="type-couche-filter">Layer Type (TYPE_COUCHE)</label>
            <select id="type-couche-filter">
                <option value="">All Types</option>
                <option value="BBSG">BBSG</option>
                <option value="GNT">GNT</option>
            </select>
            <label for="entreprise-filter">Company (ENTREPRISE)</label>
            <select id="entreprise-filter">
                <option value="">All Companies</option>
                <option value="Colas">Colas</option>
                <option value="Eurovia">Eurovia</option>
            </select>
            <label>PR Range (PR_1 to PR_2)</label>
            <div class="input-row">
                <input type="number" id="pr1-filter" placeholder="Min">
                <input type="number" id="pr2-filter" placeholder="Max">
            </div>
            <button id="apply-filters-btn" class="btn-primary" style="margin-top: 1rem;">Apply Filters</button>
            <button id="reset-filters-btn">Reset</button>
        </div>

        <div class="control-group">
            <h3>Clipping Tools</h3>
            <button id="enableClipBtn">Enable/Disable Clipping</button>
            <button id="inverseClipBtn">Inverse Clipping</button>
            <button id="removeClipBtn">Remove Last Polygon</button>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let cesiumViewer;
        let mainTileset;

        async function setupCesium() {
            const loadingOverlay = document.getElementById("loadingOverlay");
            try {
                Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyY2I0NzZkYy0zY2E1LTQyZjItOGExMC0xODdhNDFjMzhkNTQiLCJpZCI6MjgzODIyLCJpYXQiOjE3NDE4NDIzNDN9.vKLm9Z15kR3oMQfUkQH5F4vNithJ-vOKHRya8dlHdXY";
                cesiumViewer = new Cesium.Viewer("cesiumContainer", {
                    timeline: false, animation: false, sceneModePicker: false, baseLayerPicker: false,
                    geocoder: true, creditContainer: document.createElement("div"),
                    infoBox: false, selectionIndicator: false
                });

                cesiumViewer.scene.globe.enableLighting = true;
                await Cesium.createWorldTerrainAsync().then(terrain => { cesiumViewer.scene.terrainProvider = terrain; });

                mainTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3385864);
                cesiumViewer.scene.primitives.add(mainTileset);
                await cesiumViewer.zoomTo(mainTileset);

                mainTileset.clippingPolygons = new Cesium.ClippingPolygonCollection({
                    edgeColor: Cesium.Color.WHITE, edgeWidth: 1.0, enabled: true
                });

                loadingOverlay.style.opacity = "0";
                setTimeout(() => { loadingOverlay.style.display = "none"; }, 500);

            } catch (error) {
                console.error("Cesium setup failed:", error);
                loadingOverlay.querySelector("h1").textContent = `Error: ${error.message}`;
            }
        }

        function setupClippingTools() {
            const handler = new Cesium.ScreenSpaceEventHandler(cesiumViewer.canvas);
            let activeShapePoints = [];
            let activeShape;
            let floatingPoint;

            handler.setInputAction(event => {
                const earthPosition = cesiumViewer.scene.pickPosition(event.position);
                if (Cesium.defined(earthPosition)) {
                    if (activeShapePoints.length === 0) {
                        floatingPoint = cesiumViewer.entities.add({ position: earthPosition, point: { color: Cesium.Color.ORANGERED, pixelSize: 8 } });
                        activeShapePoints.push(earthPosition);
                        const dynamicPositions = new Cesium.CallbackProperty(() => new Cesium.PolygonHierarchy(activeShapePoints), false);
                        activeShape = cesiumViewer.entities.add({ polygon: { hierarchy: dynamicPositions, material: Cesium.Color.ORANGERED.withAlpha(0.7) } });
                    }
                    activeShapePoints.push(earthPosition);
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            handler.setInputAction(event => {
                if (Cesium.defined(floatingPoint)) {
                    const newPosition = cesiumViewer.scene.pickPosition(event.endPosition);
                    if (Cesium.defined(newPosition)) {
                        floatingPoint.position.setValue(newPosition);
                        activeShapePoints.pop();
                        activeShapePoints.push(newPosition);
                    }
                }
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

            handler.setInputAction(() => {
                if (activeShapePoints.length > 2) {
                    const finalPoints = activeShapePoints.slice(0, -1);
                    if (mainTileset?.clippingPolygons) {
                        mainTileset.clippingPolygons.add(new Cesium.ClippingPolygon({ positions: finalPoints }));
                    }
                }
                cesiumViewer.entities.removeAll();
                activeShapePoints = [];
            }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

            document.getElementById('enableClipBtn').addEventListener('click', () => mainTileset.clippingPolygons.enabled = !mainTileset.clippingPolygons.enabled);
            document.getElementById('inverseClipBtn').addEventListener('click', () => mainTileset.clippingPolygons.inverse = !mainTileset.clippingPolygons.inverse);
            document.getElementById('removeClipBtn').addEventListener('click', () => {
                if (mainTileset.clippingPolygons.length > 0) {
                    mainTileset.clippingPolygons.remove(mainTileset.clippingPolygons.get(mainTileset.clippingPolygons.length - 1));
                }
            });
        }

        function setupFilterPanel() {
            const applyBtn = document.getElementById('apply-filters-btn');
            const resetBtn = document.getElementById('reset-filters-btn');

            applyBtn.addEventListener('click', () => {
                const filters = {
                    typeCouche: document.getElementById('type-couche-filter').value,
                    entreprise: document.getElementById('entreprise-filter').value,
                    pr_start: document.getElementById('pr1-filter').value,
                    pr_end: document.getElementById('pr2-filter').value
                };
                console.log('Applying filters:', filters);
                
                // This is where you would build a new Cesium3DTileStyle condition string
                // based on the filter values and apply it to mainTileset.style
                alert('Filter logic is not yet implemented. Check the console for values.');
            });

            resetBtn.addEventListener('click', () => {
                document.getElementById('type-couche-filter').selectedIndex = 0;
                document.getElementById('entreprise-filter').selectedIndex = 0;
                document.getElementById('pr1-filter').value = '';
                document.getElementById('pr2-filter').value = '';
                console.log('Filters reset.');
                // Here you would reset the tileset style: mainTileset.style = new Cesium.Cesium3DTileStyle();
            });
        }

        // --- INITIALIZE THE APPLICATION ---
        async function initializeApp() {
            await setupCesium();
            if (cesiumViewer && mainTileset) {
                setupClippingTools();
                setupFilterPanel();
            }
        }

        initializeApp();
    </script>
</body>
</html>
