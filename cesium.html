<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>A63 Digital Twin - 3D Model</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; overflow: hidden; background-color: #f0f0f0;
        }
        #cesiumContainer {
            position: absolute; top: 0; left: 0; height: 100%; width: 100%; margin: 0; overflow: hidden; padding: 0; background: #000;
        }
        #loadingOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(30, 30, 30, 0.97); display: flex;
            flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: #ffffff; text-align: center;
            transition: opacity 0.5s ease-out;
        }
        #loadingOverlay h1 { font-size: 1.6em; margin-top: 10px; font-weight: 300; max-width: 80%; }
        #headerLogos {
            position: absolute; top: 15px; left: 15px; right: 15px; display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background-color: rgba(255, 255, 255, 0.92); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 1001; height: 70px; box-sizing: border-box;
        }
        #headerLogos nav { margin-left: auto; margin-right: auto; }
        #headerLogos nav a { font-weight: 500; color: #2c3e50; text-decoration: none; padding: 5px 15px; border-radius: 5px; transition: background-color 0.3s; }
        #headerLogos nav a:hover { background-color: #e0e0e0; }
        #logoAtlandes, #logoEelisa { height: 50px; width: auto; }
        .cesium-widget-credits { display: none !important; }
        
        #toolbar {
            position: absolute; top: 100px; left: 15px; background: rgba(45, 45, 45, 0.9); padding: 10px;
            border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000; max-width: 250px;
        }
        #toolbar button {
            background-color: #444; border: 1px solid #666; color: #fff; padding: 8px 12px; margin: 4px 2px;
            border-radius: 4px; cursor: pointer; display: block; width: calc(100% - 4px);
            box-sizing: border-box; text-align: left; transition: background-color 0.2s;
        }
        #toolbar button:hover { background-color: #5a5a5a; }
        #toolbar input[type="text"] {
            width: calc(100% - 6px); padding: 7px; margin: 4px 2px; border-radius: 4px;
            border: 1px solid #666; background-color: #222; color: #fff; box-sizing: border-box;
        }
        .toolbar-group-label {
            font-weight: bold; font-size: 0.95em; color: #00bcd4; margin-top: 12px; margin-bottom: 5px;
            padding-left: 2px; display: block; border-bottom: 1px solid #444; padding-bottom: 3px;
        }
        .toolbar-group-label:first-child { margin-top: 0; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>

    <div id="loadingOverlay">
        <h1>Loading Digital Twin Environment...</h1>
    </div>

    <div id="headerLogos">
        <img src="atlandes.jpg" alt="Atlandes Logo" id="logoAtlandes">
        <nav>
            <a href="index.html">Home</a>
            <a href="cesium.html">3D Model</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="map.html">ArcGIS Map</a>
        </nav>
        <img src="https://eelisa.eu/wp-content/uploads/2024/07/logo-digital-twins-positive-vertical-color-252x300.png" alt="EELISA Digital Twins Logo" id="logoEelisa">
    </div>

    <div id="toolbar">
        <span class="toolbar-group-label">Search by Location (PR)</span>
        <input type="text" id="prSearchInput" placeholder="Enter PR_1 or PR_2 value">
        <button id="searchPrBtn">Search & Highlight</button>
        <button id="resetSearchBtn">Reset Search</button>

        <span class="toolbar-group-label">Filter by Attributes</span>
        <input type="text" id="chantierFilter" placeholder="CHANTIER">
        <input type="text" id="entrepriseFilter" placeholder="ENTREPRISE">
        <input type="text" id="fondFilter" placeholder="FOND">
        <input type="text" id="nOrdreFilter" placeholder="N°_ORDRE">
        <input type="text" id="typeCoucheFilter" placeholder="TYPE_COUCH">
        <button id="applyFiltersBtn">Apply Filters</button>
        <button id="resetFiltersBtn">Reset Filters</button>

        <span class="toolbar-group-label">Visualization</span>
        <button id="colorizeDateBtn">Colorize by Date</button>
        <button id="resetColorBtn">Reset Colors</button>

        <span class="toolbar-group-label">Clipping Tools</span>
        <button id="enableClipBtn">Enable/Disable Clipping</button>
        <button id="inverseClipBtn">Inverse Clipping</button>
        <button id="removeClipBtn">Remove Last Polygon</button>
    </div>

    <script>
        let myTileset;
        const defaultStyle = new Cesium.Cesium3DTileStyle(); // A simple, empty style shows everything

        async function main() {
            const loadingMessageElement = document.querySelector("#loadingOverlay h1");
            const loadingOverlayElement = document.getElementById("loadingOverlay");

            try {
                Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyY2I0NzZkYy0zY2E1LTQyZjItOGExMC0xODdhNDFjMzhkNTQiLCJpZCI6MjgzODIyLCJpYXQiOjE3NDE4NDIzNDN9.vKLm9Z15kR3oMQfUkQH5F4vNithJ-vOKHRya8dlHdXY";

                const viewer = new Cesium.Viewer("cesiumContainer", {
                    timeline: false, animation: false, sceneModePicker: false, baseLayerPicker: false,
                    geocoder: true,
                    creditContainer: document.createElement("div"),
                    infoBox: false, selectionIndicator: false
                });
                const scene = viewer.scene;

                viewer.scene.globe.enableLighting = true;
                viewer.scene.postProcessStages.fxaa.enabled = true;
                viewer.cesiumWidget.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);
                scene.skyAtmosphere.show = true;

                loadingMessageElement.textContent = "Loading Global Terrain...";
                await Cesium.createWorldTerrainAsync().then(terrain => { scene.terrainProvider = terrain; });

                loadingMessageElement.textContent = "Loading Project Model...";
                // TASK 1: Use the new asset ID
                myTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3672505);
                viewer.scene.primitives.add(myTileset);
                myTileset.style = defaultStyle; // Apply default style on load

                loadingMessageElement.textContent = "Positioning Camera...";
                await viewer.zoomTo(myTileset);

                if (Cesium.defined(myTileset)) {
                    myTileset.clippingPolygons = new Cesium.ClippingPolygonCollection({
                        edgeColor: Cesium.Color.WHITE, edgeWidth: 1.0, enabled: true
                    });
                }
                
                // Clipping Logic
                const handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
                let activeShapePoints = [];
                let activeShape;
                let floatingPoint;

                handler.setInputAction(function (event) {
                    const earthPosition = scene.pickPosition(event.position);
                    if (Cesium.defined(earthPosition)) {
                        if (activeShapePoints.length === 0) {
                            floatingPoint = viewer.entities.add({
                                position: earthPosition,
                                point: { color: Cesium.Color.ORANGERED, pixelSize: 8, outlineColor: Cesium.Color.BLACK, outlineWidth: 1 },
                            });
                            activeShapePoints.push(earthPosition);
                            const dynamicPositions = new Cesium.CallbackProperty(function () {
                                return new Cesium.PolygonHierarchy(activeShapePoints);
                            }, false);
                            activeShape = viewer.entities.add({
                                polygon: {
                                    hierarchy: dynamicPositions,
                                    material: new Cesium.ColorMaterialProperty(Cesium.Color.ORANGERED.withAlpha(0.7)),
                                },
                            });
                        }
                        activeShapePoints.push(earthPosition);
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

                handler.setInputAction(function (event) {
                    if (Cesium.defined(floatingPoint)) {
                        const newPosition = scene.pickPosition(event.endPosition);
                        if (Cesium.defined(newPosition)) {
                            floatingPoint.position.setValue(newPosition);
                            activeShapePoints.pop();
                            activeShapePoints.push(newPosition);
                        }
                    }
                }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

                handler.setInputAction(function () {
                    if (activeShapePoints.length > 2) {
                        const finalPoints = activeShapePoints.slice(0, -1);
                        if (myTileset?.clippingPolygons) {
                            const newClippingPolygon = new Cesium.ClippingPolygon({ positions: finalPoints });
                            myTileset.clippingPolygons.add(newClippingPolygon);
                        }
                    }
                    viewer.entities.remove(floatingPoint);
                    viewer.entities.remove(activeShape);
                    floatingPoint = undefined;
                    activeShape = undefined;
                    activeShapePoints = [];
                }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

                // Setup UI now that the viewer and tileset are ready
                setupUIEventListeners();

                loadingOverlayElement.style.opacity = "0";
                setTimeout(() => { loadingOverlayElement.style.display = "none"; }, 500);

            } catch (error) {
                console.error("Critical error during Cesium setup:", error);
                loadingMessageElement.textContent = `Application Error: ${error.message || 'An unknown error occurred.'}`;
                loadingMessageElement.style.color = "#ffdddd";
            }
        }

        function setupUIEventListeners() {
            if (!myTileset) {
                console.error("Tileset not found. UI setup failed.");
                return;
            }

            // --- TASK 5: Search by PR ---
            document.getElementById('searchPrBtn').addEventListener('click', () => {
                const searchValue = document.getElementById('prSearchInput').value;
                if (!searchValue) return;
                myTileset.style = new Cesium.Cesium3DTileStyle({
                    color: `Boolean(\${PR_1} === '${searchValue}' || \${PR_2} === '${searchValue}') ? color('yellow', 1.0) : color('white', 0.15)`
                });
            });

            document.getElementById('resetSearchBtn').addEventListener('click', () => {
                document.getElementById('prSearchInput').value = '';
                myTileset.style = defaultStyle;
            });

            // --- TASK 3: Add All Filters ---
            document.getElementById('applyFiltersBtn').addEventListener('click', () => {
                const filters = {
                    CHANTIER: document.getElementById('chantierFilter').value,
                    ENTREPRISE: document.getElementById('entrepriseFilter').value,
                    FOND: document.getElementById('fondFilter').value,
                    'N°_ORDRE': document.getElementById('nOrdreFilter').value,
                    TYPE_COUCH: document.getElementById('typeCoucheFilter').value
                };

                let conditions = [];
                for (const key in filters) {
                    if (filters[key]) {
                        // Use getProperty for names with special characters like '°'
                        const propertyName = /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(key) ? `\${${key}}` : `getProperty('${key}')`;
                        // Assume string comparison. Add quotes around the filter value.
                        conditions.push(`${propertyName} === '${filters[key]}'`);
                    }
                }

                if (conditions.length > 0) {
                    myTileset.style = new Cesium.Cesium3DTileStyle({ show: conditions.join(' && ') });
                } else {
                    myTileset.style = defaultStyle; // If no filters, show all
                }
            });
            
            document.getElementById('resetFiltersBtn').addEventListener('click', () => {
                document.getElementById('chantierFilter').value = '';
                document.getElementById('entrepriseFilter').value = '';
                document.getElementById('fondFilter').value = '';
                document.getElementById('nOrdreFilter').value = '';
                document.getElementById('typeCoucheFilter').value = '';
                myTileset.style = defaultStyle;
            });

            // --- TASK 4: Colorize by Date ---
            document.getElementById('colorizeDateBtn').addEventListener('click', () => {
