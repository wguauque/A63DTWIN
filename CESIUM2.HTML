<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>A63 Digital Twin - 3D Model</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #cesiumContainer { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.5s ease; }
        #headerLogos { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: rgba(255, 255, 255, 0.95); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 1001; height: 70px; box-sizing: border-box; }
        #logoAtlandes, #logoEelisa { height: 45px; width: auto; }
        .cesium-widget-credits { display: none !important; }
        
        #toolbar { position: absolute; top: 100px; left: 15px; background: rgba(45,45,45,0.9); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; max-width: 280px; color: white; }
        .toolbar-group-label { font-weight: bold; font-size: 0.95em; color: #00bcd4; margin-top: 12px; margin-bottom: 8px; padding-left: 2px; display: block; border-bottom: 1px solid #444; padding-bottom: 3px; }
        #toolbar input, #toolbar select, #toolbar button { width: calc(100% - 4px); padding: 8px; margin: 4px 2px; border-radius: 4px; border: 1px solid #666; background-color: #333; color: #fff; box-sizing: border-box; }
        #toolbar button { background-color: #444; cursor: pointer; text-align: left; }

        .pr-search-container { position: relative; }
        #autocomplete-results {
            position: absolute;
            top: 100%; left: 2px; right: 2px;
            background: #3a3a3a; border: 1px solid #777; border-top: none;
            border-radius: 0 0 4px 4px; z-index: 1002;
            max-height: 200px; overflow-y: auto;
        }
        .autocomplete-item { padding: 8px; color: #fff; cursor: pointer; }
        .autocomplete-item:hover { background-color: #555; }
        #infobox {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(35, 35, 35, 0.9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            display: none;
            max-width: 320px;
            border: 1px solid #666;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1000;
            font-size: 0.9em;
        }
        #infobox h3 { margin-top: 0; padding-bottom: 5px; border-bottom: 1px solid #555; color: #00bcd4; }
        #infobox table { width: 100%; border-collapse: collapse; }
        #infobox th, #infobox td { padding: 5px 2px; text-align: left; }
        #infobox th { font-weight: bold; color: #ccc; width: 40%; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>
    <div id="loadingOverlay"><h1>Loading Digital Twin...</h1></div>

    <div id="infobox"></div>

    <div id="headerLogos">
        <img src="atlandes.jpg" alt="Atlandes Logo" id="logoAtlandes">
        <img src="https://eelisa.eu/wp-content/uploads/2024/07/logo-digital-twins-positive-vertical-color-252x300.png" alt="EELISA Logo" id="logoEelisa">
    </div>

    <div id="toolbar">
        <span class="toolbar-group-label">Basemap</span>
        <select id="basemap-picker">
            <option value="imagery" selected>Satellite Imagery</option>
            <option value="photorealistic">3D Photorealistic</option>
        </select>
        
        <span class="toolbar-group-label">Tools</span>
        <button id="measure-btn">Activate Measurement Tool</button>
        <button id="date-color-btn">Color by Date</button>
        
        <span class="toolbar-group-label">Navigate Highway (by PR)</span>
        <div class="pr-search-container">
            <input type="text" id="pr-search" placeholder="Search PR (e.g., 98)">
            <div id="autocomplete-results"></div>
        </div>
        <div id="navigation-controls" style="display: flex; justify-content: space-between; margin-top: 8px;">
            <button id="prev-pr-btn" style="width: 48%; text-align: center;">&lt; Prev PR</button>
            <button id="next-pr-btn" style="width: 48%; text-align: center;">Next PR &gt;</button>
        </div>

        <span class="toolbar-group-label">Filter by Company</span>
        <select id="entreprise-filter"></select>
        
        <span class="toolbar-group-label">Filter & Search by Material</span>
        <label for="material-filter" style="font-size:0.85em; margin-left: 2px;">Filter by Material (name_1)</label>
        <select id="material-filter"></select>
        
        <label for="material-search" style="font-size:0.85em; margin-left: 2px; margin-top: 10px; display: block;">Highlight by Material (name_1)</label>
        <input type="text" id="material-search" placeholder="e.g., BBSG">
        
        <button id="reset-btn" style="margin-top: 10px;">Reset View</button>
    </div>

    <script>
        const materialList = [ 'BBSG 0/14', 'BBSG', 'BBSG 0/10 R50', 'GNT', 'GNT 0/31.5', 'GB', 'GB 0/14 R50', 'GB 014 OPTIBASE', 'SB', 'GTLH', 'geotextile classe 7', 'BBTM 0/10', 'BBTM 0/10 R20', 'EME2 0/14R30', 'BBME3 R30', 'BBDr 0/10', 'BB 0/6 acc', 'BB Accoustiq', 'BBME 0/10R15', 'BBME 0/10 R30', 'EME 0/14 R30', 'BBME', 'TAB BET', 'CBX C30/37', 'CBX C25/30', 'Etanch', 'Autres' ];
        const companyList = [ 'COLAS SO', 'GIE A63', 'GIE-COLAS SO', 'GPT  COLAS-MALLET-SIORAT', 'LAFITTE TP', 'PRESTATAIRE PREMIER GER' ];
        const prList = [];
        for (let i = 34; i <= 140; i++) { prList.push(i.toString()); }
        
        const allowedProperties = ['TYPECOUCH', 'SURFACE', 'ENTREPRISE', 'PR1', 'NORDRE', 'CHANTIER', 'FOND', 'PR2', 'DATEMS'];

        let myTileset, defaultStyle, viewer, photorealisticTileset, defaultImageryLayer;
        let selectedFeature = undefined;
        let originalColor = new Cesium.Color();
        const highlightColor = Cesium.Color.AQUA;
        
        let isMeasuring = false;
        let measurementDataSource;
        let measurementHandler;

        const appState = { materialFilter: '', entrepriseFilter: '', materialSearch: '', prSearch: '', currentPrIndex: -1, isDateViewActive: false };

        function getMaterialColor(material) {
            const upperMaterial = material.toUpperCase();
            if (upperMaterial.includes('BBSG') || upperMaterial.includes('BBTM') || upperMaterial.includes('BBME') || upperMaterial.includes('EME') || upperMaterial.includes('BBDR') || upperMaterial.includes('ACCOUSTIQ') || upperMaterial.includes('ACC')) { return Cesium.Color.DARKSLATEGRAY.toCssColorString(); }
            if (upperMaterial.includes('GB') || upperMaterial.includes('GNT')) { return Cesium.Color.GRAY.toCssColorString(); }
            if (upperMaterial.includes('SB') || upperMaterial.includes('GTLH') || upperMaterial.includes('FORME')) { return Cesium.Color.BURLYWOOD.toCssColorString(); }
            if (upperMaterial.includes('BET') || upperMaterial.includes('CBX')) { return Cesium.Color.LIGHTGRAY.toCssColorString(); }
            if (upperMaterial.includes('GEOTEXTILE')) { return Cesium.Color.WHITESMOKE.toCssColorString(); }
            if (upperMaterial.includes('ETANCH')) { return Cesium.Color.STEELBLUE.toCssColorString(); }
            return Cesium.Color.DIMGRAY.toCssColorString();
        }

        // --- FIXED FUNCTION TO USE NUMERIC YEAR COMPARISON ---
        function applyDateStyle() {
            if (!myTileset) return;

            const now = new Date();
            const year15Ago = now.getFullYear() - 15;
            const year30Ago = now.getFullYear() - 30;

            // This expression uses a regular expression to extract the 4-digit year 
            // from the start of the date string and converts it to a number.
            const yearExpression = "Number(regExp('^([0-9]{4})').exec(String(${excelLayerInfoDATEMS}))[1])";

            myTileset.style = new Cesium.Cesium3DTileStyle({
                color: {
                    conditions: [
                        // Now we compare the extracted year as a number
                        [`${yearExpression} < ${year30Ago}`, "color('red')"],
                        [`${yearExpression} >= ${year30Ago} && ${yearExpression} < ${year15Ago}`, "color('yellow')"],
                        [`${yearExpression} >= ${year15Ago}`, "color('lime')"],
                        ['true', "color('gray')"] // Default for features with an invalid date format
                    ]
                }
            });
        }

        function updateTilesetStyle() {
            if (appState.isDateViewActive) {
                applyDateStyle();
                return; 
            }
            if (!myTileset || !defaultStyle) return;

            let showConditions = [];
            if (appState.materialFilter) { showConditions.push(`\${name_1} === '${appState.materialFilter}'`); }
            if (appState.entrepriseFilter) { showConditions.push(`\${excelLayerInfoENTREPRISE} === '${appState.entrepriseFilter}'`); }
            const showExpression = showConditions.length > 0 ? showConditions.join(' && ') : 'true';
            let colorExpression;
            if (appState.prSearch) { colorExpression = `round(Number(\${excelLayerInfoPR1}) / 1000) === ${Number(appState.prSearch)} ? color('magenta') : defaultStyle.color.expression`; } 
            else if (appState.materialSearch) { colorExpression = `regExp('${appState.materialSearch}', 'i').test(\${name_1}) ? color('yellow') : defaultStyle.color.expression`; } 
            else { colorExpression = defaultStyle.color.expression; }
            myTileset.style = new Cesium.Cesium3DTileStyle({ show: showExpression, color: colorExpression });
        }

        function zoomToFeature(prValue) {
            if (!myTileset || !viewer || !prValue) return;
            const prNumber = Number(prValue);
            if (isNaN(prNumber)) return;
            const zoomStyle = new Cesium.Cesium3DTileStyle({ show: `round(Number(\${excelLayerInfoPR1}) / 1000) === ${prNumber}` });
            myTileset.style = zoomStyle;
            setTimeout(async () => {
                try {
                    await viewer.zoomTo(myTileset, new Cesium.HeadingPitchRange(0.0, Cesium.Math.toRadians(-75), 2500));
                } catch (error) {
                    console.error("Error during zoomTo operation:", error);
                    alert("Could not zoom to the selected PR. The data may not exist or is not currently loaded.");
                } finally { updateTilesetStyle(); }
            }, 250);
        }

        async function main() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            try {
                Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjOWE1NDNmOC02MzkxLTQyMWUtODFiOC1iYzMwZTZkMjg0OTUiLCJpZCI6MjgzODIyLCJpYXQiOjE3NTcxMjM2OTN9.SLvGBcu3zALbkrbRqQZS4KRrn960cXEbpW-7xWIavCY";
                viewer = new Cesium.Viewer("cesiumContainer", { timeline: false, animation: false, sceneModePicker: false, baseLayer: false, geocoder: true, creditContainer: document.createElement("div"), infoBox: false, selectionIndicator: false, requestRenderMode: true, maximumRenderTimeChange: Infinity });
                viewer.scene.globe.enableLighting = true;
                viewer.scene.fog.enabled = true;
                viewer.scene.fog.density = 0.0002;
                viewer.scene.screenSpaceCameraController.minimumZoomDistance = 100;
                
                defaultImageryLayer = viewer.scene.imageryLayers.addImageryProvider(await Cesium.createWorldImageryAsync());
                
                loadingOverlay.querySelector('h1').textContent = "Loading Basemap...";
                try {
                    photorealisticTileset = await Cesium.createGooglePhotorealistic3DTileset();
                    photorealisticTileset.dynamicScreenSpaceError = true;
                    photorealisticTileset.dynamicScreenSpaceErrorDensity = 0.00278;
                    photorealisticTileset.dynamicScreenSpaceErrorFactor = 4.0;
                    viewer.scene.primitives.add(photorealisticTileset);
                    photorealisticTileset.show = false; 
                } catch (error) { console.error("Could not load Google Photorealistic 3D Tiles:", error); document.getElementById('basemap-picker').disabled = true; }

                loadingOverlay.querySelector('h1').textContent = "Loading Terrain...";
                viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(3693677);

                loadingOverlay.querySelector('h1').textContent = "Loading 3D Model...";
                myTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3694449);
                viewer.scene.primitives.add(myTileset);
                await myTileset.readyPromise;

                const heightOffset = 50.0;
                const cartographic = Cesium.Cartographic.fromCartesian(myTileset.boundingSphere.center);
                const surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 0.0);
                const offset = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, heightOffset);
                const translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
                myTileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);

                const colorConditions = materialList.map((material) => [`\${name_1} === '${material}'`, `color('${getMaterialColor(material)}')`]);
                colorConditions.push([true, "color('white')"]);
                defaultStyle = new Cesium.Cesium3DTileStyle({ color: { conditions: colorConditions } });
                myTileset.style = defaultStyle;

                measurementDataSource = new Cesium.CustomDataSource('measurementDataSource');
                viewer.dataSources.add(measurementDataSource);

                buildMaterialFilterUI();
                buildEntrepriseFilterUI();
                setupEventListeners();

                loadingOverlay.querySelector('h1').textContent = "Positioning Camera...";
                await viewer.zoomTo(myTileset);
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
            } catch (error) { console.error("Critical error during Cesium setup:", error); loadingOverlay.querySelector('h1').textContent = `Application Error: ${error.message}`; }
        }

        function buildMaterialFilterUI() { const select = document.getElementById('material-filter'); select.innerHTML = ''; const allOption = document.createElement('option'); allOption.value = ''; allOption.textContent = 'Show All Materials'; select.appendChild(allOption); materialList.forEach(material => { const option = document.createElement('option'); option.value = material; option.textContent = material; select.appendChild(option); }); }
        function buildEntrepriseFilterUI() { const select = document.getElementById('entreprise-filter'); select.innerHTML = ''; const allOption = document.createElement('option'); allOption.value = ''; allOption.textContent = 'Show All Companies'; select.appendChild(allOption); companyList.forEach(company => { const option = document.createElement('option'); option.value = company; option.textContent = company; select.appendChild(option); }); }
        
        function navigateToPr(pr) { deactivateDateView(); const prSearchInput = document.getElementById('pr-search'); prSearchInput.value = pr; document.getElementById('autocomplete-results').innerHTML = ''; document.getElementById('material-search').value = ''; appState.materialSearch = ''; appState.prSearch = pr; appState.currentPrIndex = prList.indexOf(pr); updateTilesetStyle(); zoomToFeature(pr); }
        
        function displayFeatureInfo(feature) {
            const infobox = document.getElementById('infobox');
            const propertyIds = feature.getPropertyIds();
            let content = '<h3>Selected Feature</h3><table>';

            for (let i = 0; i < propertyIds.length; i++) {
                const propName = propertyIds[i];
                const displayName = propName.replace('excelLayerInfo', '');
                
                if (allowedProperties.includes(displayName.toUpperCase())) {
                    let propValue = feature.getProperty(propName);
                    if (displayName.toUpperCase() === 'DATEMS' && propValue) {
                        propValue = propValue.split(' ')[0];
                    }
                    propValue = (propValue === null || propValue === undefined) ? "N/A" : propValue;
                    content += `<tr><th>${displayName}</th><td>${propValue}</td></tr>`;
                }
            }
            content += '</table>';
            infobox.innerHTML = content;
            infobox.style.display = 'block';
        }
        
        function activateMeasurement() { isMeasuring = true; document.getElementById('measure-btn').textContent = 'Deactivate Measurement (Right-click to finish)'; document.getElementById('measure-btn').style.backgroundColor = '#00bcd4'; measurementHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas); let positions = []; let totalDistance = 0; let dynamicLine, distanceLabel; measurementHandler.setInputAction(function (movement) { if (positions.length === 0) return; const cartesian = viewer.scene.pickPosition(movement.endPosition); if (!Cesium.defined(cartesian)) return; if (!Cesium.defined(dynamicLine)) { dynamicLine = measurementDataSource.entities.add({ polyline: { positions: new Cesium.CallbackProperty(() => [positions[positions.length - 1], cartesian], false), width: 2, material: Cesium.Color.YELLOW } }); } const segmentDistance = Cesium.Cartesian3.distance(positions[positions.length - 1], cartesian); distanceLabel.position = cartesian; distanceLabel.label.text = `Total: ${(totalDistance + segmentDistance).toFixed(2)} m`; }, Cesium.ScreenSpaceEventType.MOUSE_MOVE); measurementHandler.setInputAction(function (click) { const cartesian = viewer.scene.pickPosition(click.position); if (!Cesium.defined(cartesian)) return; positions.push(cartesian); if (positions.length > 1) { const lastPoint = positions[positions.length - 2]; totalDistance += Cesium.Cartesian3.distance(lastPoint, cartesian); measurementDataSource.entities.add({ polyline: { positions: [lastPoint, cartesian], width: 3, material: Cesium.Color.ORANGERED } }); } measurementDataSource.entities.add({ position: cartesian, point: { pixelSize: 8, color: Cesium.Color.ORANGERED } }); if (!Cesium.defined(distanceLabel)) { distanceLabel = measurementDataSource.entities.add({ position: cartesian, label: { text: 'Start measuring', font: '14pt monospace', style: Cesium.LabelStyle.FILL_AND_OUTLINE, outlineWidth: 2, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -9) } }); } }, Cesium.ScreenSpaceEventType.LEFT_CLICK); measurementHandler.setInputAction(() => deactivateMeasurement(), Cesium.ScreenSpaceEventType.RIGHT_CLICK); }
        function deactivateMeasurement() { isMeasuring = false; if (Cesium.defined(measurementHandler)) { measurementHandler.destroy(); measurementHandler = undefined; } measurementDataSource.entities.removeAll(); document.getElementById('measure-btn').textContent = 'Activate Measurement Tool'; document.getElementById('measure-btn').style.backgroundColor = '#444'; }
        
        function deactivateDateView() {
            appState.isDateViewActive = false;
            const dateColorBtn = document.getElementById('date-color-btn');
            dateColorBtn.textContent = 'Color by Date';
            dateColorBtn.style.backgroundColor = '#444';
        }

        function setupEventListeners() {
            const measureBtn = document.getElementById('measure-btn');
            const dateColorBtn = document.getElementById('date-color-btn');
            const selectionHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

            const selectFeatureAction = function (movement) { if (isMeasuring) return; if (Cesium.defined(selectedFeature)) { selectedFeature.color = originalColor; selectedFeature = undefined; } const pickedFeature = viewer.scene.pick(movement.position); const infobox = document.getElementById('infobox'); if (pickedFeature instanceof Cesium.Cesium3DTileFeature) { selectedFeature = pickedFeature; Cesium.Color.clone(selectedFeature.color, originalColor); selectedFeature.color = highlightColor; displayFeatureInfo(pickedFeature); } else { infobox.style.display = 'none'; } };
            selectionHandler.setInputAction(selectFeatureAction, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            measureBtn.addEventListener('click', () => { if (isMeasuring) { deactivateMeasurement(); } else { deactivateDateView(); updateTilesetStyle(); activateMeasurement(); } });
            dateColorBtn.addEventListener('click', () => {
                appState.isDateViewActive = !appState.isDateViewActive;
                if (appState.isDateViewActive) {
                    dateColorBtn.textContent = 'Deactivate Date View';
                    dateColorBtn.style.backgroundColor = '#00bcd4';
                    deactivateMeasurement();
                } else {
                    deactivateDateView();
                }
                updateTilesetStyle();
            });

            document.getElementById('basemap-picker').addEventListener('change', (event) => { const selectedBasemap = event.target.value; if (selectedBasemap === 'photorealistic') { if(photorealisticTileset) photorealisticTileset.show = true; defaultImageryLayer.show = false; viewer.scene.globe.baseColor = Cesium.Color.BLACK; } else { if(photorealisticTileset) photorealisticTileset.show = false; defaultImageryLayer.show = true; viewer.scene.globe.baseColor = Cesium.Color.TRANSPARENT; } });
            document.getElementById('pr-search').addEventListener('input', () => { deactivateDateView(); const value = document.getElementById('pr-search').value.toLowerCase(); const autocompleteResults = document.getElementById('autocomplete-results'); autocompleteResults.innerHTML = ''; if (!value) { appState.prSearch = ''; updateTilesetStyle(); return; } const filteredPRs = prList.filter(pr => pr.toLowerCase().startsWith(value)); filteredPRs.forEach(pr => { const item = document.createElement('div'); item.className = 'autocomplete-item'; item.textContent = pr; item.addEventListener('click', () => navigateToPr(pr)); autocompleteResults.appendChild(item); }); });
            document.getElementById('prev-pr-btn').addEventListener('click', () => { if (appState.currentPrIndex > 0) { navigateToPr(prList[appState.currentPrIndex - 1]); } });
            document.getElementById('next-pr-btn').addEventListener('click', () => { if (appState.currentPrIndex < prList.length - 1) { navigateToPr(prList[appState.currentPrIndex + 1]); } });
            document.getElementById('material-filter').addEventListener('change', () => { deactivateDateView(); appState.materialFilter = document.getElementById('material-filter').value; updateTilesetStyle(); });
            document.getElementById('entreprise-filter').addEventListener('change', () => { deactivateDateView(); appState.entrepriseFilter = document.getElementById('entreprise-filter').value; updateTilesetStyle(); });
            document.getElementById('material-search').addEventListener('input', () => { deactivateDateView(); document.getElementById('pr-search').value = ''; document.getElementById('autocomplete-results').innerHTML = ''; appState.prSearch = ''; appState.materialSearch = document.getElementById('material-search').value; updateTilesetStyle(); });
            document.getElementById('reset-btn').addEventListener('click', () => { deactivateDateView(); document.getElementById('material-filter').value = ''; document.getElementById('entreprise-filter').value = ''; document.getElementById('material-search').value = ''; document.getElementById('pr-search').value = ''; document.getElementById('autocomplete-results').innerHTML = ''; appState.materialFilter = ''; appState.entrepriseFilter = ''; appState.materialSearch = ''; appState.prSearch = ''; appState.currentPrIndex = -1; myTileset.style = defaultStyle; viewer.zoomTo(myTileset); });
        }
        
        main();
    </script>
</body>
</html>
