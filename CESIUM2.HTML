<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>A63 Digital Twin - 3D Model</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #cesiumContainer { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.5s ease; }
        #headerLogos { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: rgba(255, 255, 255, 0.95); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 1001; height: 70px; box-sizing: border-box; }
        #logoAtlandes, #logoEelisa { height: 50px; }
        .cesium-widget-credits { display: none !important; }
        
        #toolbar { position: absolute; top: 100px; left: 15px; background: rgba(45,45,45,0.9); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; max-width: 280px; color: white; }
        .toolbar-group-label { font-weight: bold; font-size: 0.95em; color: #00bcd4; margin-top: 12px; margin-bottom: 8px; padding-left: 2px; display: block; border-bottom: 1px solid #444; padding-bottom: 3px; }
        #toolbar input, #toolbar select, #toolbar button { width: calc(100% - 4px); padding: 8px; margin: 4px 2px; border-radius: 4px; border: 1px solid #666; background-color: #333; color: #fff; box-sizing: border-box; }
        #toolbar button { background-color: #444; cursor: pointer; text-align: left; }

        /* Styles for PR Autocomplete */
        .pr-search-container { position: relative; }
        #autocomplete-results {
            position: absolute;
            top: 100%;
            left: 2px;
            right: 2px;
            background: #3a3a3a;
            border: 1px solid #777;
            border-top: none;
            border-radius: 0 0 4px 4px;
            z-index: 1002;
            max-height: 200px;
            overflow-y: auto;
        }
        .autocomplete-item {
            padding: 8px;
            color: #fff;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background-color: #555;
        }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>
    <div id="loadingOverlay"><h1>Loading Digital Twin...</h1></div>

    <div id="headerLogos">
        <img src="atlandes.jpg" alt="Atlandes Logo" id="logoAtlandes">
        <img src="https://eelisa.eu/wp-content/uploads/2024/07/logo-digital-twins-positive-vertical-color-252x300.png" alt="EELISA Logo" id="logoEelisa">
    </div>

    <div id="toolbar">
        <span class="toolbar-group-label">Search by PR</span>
        <div class="pr-search-container">
            <input type="text" id="pr-search" placeholder="Enter PR (e.g., 98000)">
            <div id="autocomplete-results"></div>
        </div>

        <span class="toolbar-group-label">Filter & Search by Material</span>
        <label for="material-filter" style="font-size:0.85em; margin-left: 2px;">Filter by Material (name_1)</label>
        <select id="material-filter"></select>
        
        <label for="material-search" style="font-size:0.85em; margin-left: 2px; margin-top: 10px; display: block;">Highlight by Material (name_1)</label>
        <input type="text" id="material-search" placeholder="e.g., BBSG">
        
        <button id="reset-btn" style="margin-top: 10px;">Reset View</button>
    </div>

    <script>
        const materialList = [
            'BBSG 0/14', 'BBSG', 'BBSG 0/10 R50', 'GNT', 'GNT 0/31.5', 'GB', 
            'GB 0/14 R50', 'GB 014 OPTIBASE', 'SB', 'GTLH', 'geotextile classe 7',
            'BBTM 0/10', 'BBTM 0/10 R20', 'EME2 0/14R30', 'BBME3 R30', 'BBDr 0/10',
            'BB 0/6 acc', 'BB Accoustiq', 'BBME 0/10R15', 'BBME 0/10 R30', 'EME 0/14 R30', 'BBME',
            'TAB BET', 'CBX C30/37', 'CBX C25/30', 'Etanch', 'Autres'
        ];
        
        const prList = [];
        for (let i = 34000; i <= 140000; i += 1000) {
            prList.push(i.toString());
        }

        let myTileset;
        let defaultStyle;
        let viewer; 
        
        const appState = {
            materialFilter: '',
            materialSearch: '',
            prSearch: ''
        };

        // ===================================================================================
        // --- STYLE & VIEW LOGIC ---
        // ===================================================================================
        
        /**
         * Returns a CSS color string based on the material name for thematic mapping.
         * @param {string} material The name of the material.
         * @returns {string} A CSS color string.
         */
        function getMaterialColor(material) {
            const upperMaterial = material.toUpperCase();
            if (upperMaterial.includes('BBSG') || upperMaterial.includes('BBTM') || upperMaterial.includes('BBME') || upperMaterial.includes('EME') || upperMaterial.includes('BBDR') || upperMaterial.includes('ACCOUSTIQ') || upperMaterial.includes('ACC')) {
                return Cesium.Color.DARKSLATEGRAY.toCssColorString(); // Asphalt layers
            }
            if (upperMaterial.includes('GB') || upperMaterial.includes('GNT')) {
                return Cesium.Color.GRAY.toCssColorString(); // Base layers
            }
            if (upperMaterial.includes('SB') || upperMaterial.includes('GTLH') || upperMaterial.includes('FORME')) {
                return Cesium.Color.BURLYWOOD.toCssColorString(); // Subbase layers
            }
            if (upperMaterial.includes('BET') || upperMaterial.includes('CBX')) {
                return Cesium.Color.LIGHTGRAY.toCssColorString(); // Concrete
            }
            if (upperMaterial.includes('GEOTEXTILE')) {
                return Cesium.Color.WHITESMOKE.toCssColorString();
            }
            if (upperMaterial.includes('ETANCH')) {
                return Cesium.Color.STEELBLUE.toCssColorString();
            }
            return Cesium.Color.SEAGREEN.toCssColorString(); // Default for 'Autres', etc.
        }

        function updateTilesetStyle() {
            if (!myTileset || !defaultStyle) return;

            let showExpression = 'true';
            if (appState.materialFilter) {
                showExpression = `\${name_1} === '${appState.materialFilter}'`;
            }

            let colorExpression;
            if (appState.prSearch) {
                colorExpression = `getProperty('excelLayerInfoPR_1') === '${appState.prSearch}' ? color('magenta') : defaultStyle.color.expression`;
            } else if (appState.materialSearch) {
                colorExpression = `regExp('${appState.materialSearch}', 'i').test(\${name_1}) ? color('yellow') : defaultStyle.color.expression`;
            } else {
                colorExpression = defaultStyle.color.expression;
            }

            myTileset.style = new Cesium.Cesium3DTileStyle({
                show: showExpression,
                color: colorExpression
            });
        }

        function zoomToFeature(prValue) {
            if (!myTileset || !viewer || !prValue) return;

            const prNumber = Number(prValue);
            if (isNaN(prNumber)) return;

            const lowerBound = prNumber - 500;
            const upperBound = prNumber + 500;

            const zoomStyle = new Cesium.Cesium3DTileStyle({
                show: `Number(getProperty('excelLayerInfoPR_1')) >= ${lowerBound} && Number(getProperty('excelLayerInfoPR_1')) < ${upperBound}`
            });
            myTileset.style = zoomStyle;

            // Add a short delay to allow the scene to update with the new style before zooming.
            // This makes the zoom action more reliable.
            setTimeout(async () => {
                try {
                    await viewer.zoomTo(myTileset, new Cesium.HeadingPitchRange(0.0, Cesium.Math.toRadians(-90), 0));
                } catch (error) {
                    console.error("Error during zoomTo operation:", error);
                } finally {
                    updateTilesetStyle(); // Restore the interactive style after the zoom.
                }
            }, 100); // 100ms delay
        }


        // ===================================================================================
        // --- MAIN APPLICATION SETUP ---
        // ===================================================================================
        async function main() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            try {
                Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyY2I0NzZkYy0zY2E1LTQyZjItOGExMC0xODdhNDFjMzhkNTQiLCJpZCI6MjgzODIyLCJpYXQiOjE3NDE4NDIzNDN9.vKLm9Z15kR3oMQfUkQH5F4vNithJ-vOKHRya8dlHdXY";
                viewer = new Cesium.Viewer("cesiumContainer", {
                    timeline: false, animation: false, sceneModePicker: false, 
                    baseLayerPicker: false, geocoder: true, 
                    creditContainer: document.createElement("div"), infoBox: false, selectionIndicator: false 
                });
                viewer.scene.globe.enableLighting = true;
                
                loadingOverlay.querySelector('h1').textContent = "Loading Terrain...";
                viewer.terrainProvider = await Cesium.createWorldTerrainAsync();

                loadingOverlay.querySelector('h1').textContent = "Loading 3D Model...";
                myTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3672505);
                viewer.scene.primitives.add(myTileset);
                
                await myTileset.readyPromise;

                // Apply a fixed vertical offset to raise the model.
                const heightOffset = 50.0; // Raise the model by 50 meters.
                const cartographic = Cesium.Cartographic.fromCartesian(myTileset.boundingSphere.center);
                const surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 0.0);
                const offset = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, heightOffset);
                const translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
                myTileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);

                // Build the default style using the new thematic color function.
                const colorConditions = materialList.map((material) => {
                    return [`\${name_1} === '${material}'`, `color('${getMaterialColor(material)}')`];
                });
                colorConditions.push([true, "color('white')"]); // Fallback color
                defaultStyle = new Cesium.Cesium3DTileStyle({ color: { conditions: colorConditions } });
                myTileset.style = defaultStyle;

                buildFilterUI();
                setupEventListeners();

                loadingOverlay.querySelector('h1').textContent = "Positioning Camera...";
                await viewer.zoomTo(myTileset);
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);

            } catch (error) {
                console.error("Critical error during Cesium setup:", error);
                loadingOverlay.querySelector('h1').textContent = `Application Error: ${error.message}`;
            }
        }

        function buildFilterUI() {
            const select = document.getElementById('material-filter');
            select.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'Show All Materials';
            select.appendChild(allOption);
            materialList.forEach(material => {
                const option = document.createElement('option');
                option.value = material;
                option.textContent = material;
                select.appendChild(option);
            });
        }

        function setupEventListeners() {
            const prSearchInput = document.getElementById('pr-search');
            const autocompleteResults = document.getElementById('autocomplete-results');
            const materialFilter = document.getElementById('material-filter');
            const materialSearch = document.getElementById('material-search');

            prSearchInput.addEventListener('input', () => {
                const value = prSearchInput.value.toLowerCase();
                autocompleteResults.innerHTML = '';
                if (!value) {
                    appState.prSearch = '';
                    updateTilesetStyle();
                    return;
                }
                
                const filteredPRs = prList.filter(pr => pr.toLowerCase().startsWith(value));
                filteredPRs.forEach(pr => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = pr;
                    item.addEventListener('click', () => {
                        prSearchInput.value = pr;
                        autocompleteResults.innerHTML = '';
                        materialSearch.value = '';
                        appState.materialSearch = '';
                        appState.prSearch = pr;
                        
                        updateTilesetStyle();
                        zoomToFeature(pr);
                    });
                    autocompleteResults.appendChild(item);
                });
            });

            materialFilter.addEventListener('change', () => {
                appState.materialFilter = materialFilter.value;
                updateTilesetStyle();
            });

            materialSearch.addEventListener('input', () => {
                prSearchInput.value = '';
                autocompleteResults.innerHTML = '';
                appState.prSearch = '';
                appState.materialSearch = materialSearch.value;
                updateTilesetStyle();
            });
            
            document.getElementById('reset-btn').addEventListener('click', () => {
                materialFilter.value = '';
                materialSearch.value = '';
                prSearchInput.value = '';
                autocompleteResults.innerHTML = '';
                
                appState.materialFilter = '';
                appState.materialSearch = '';
                appState.prSearch = '';
                
                myTileset.style = defaultStyle;
                viewer.zoomTo(myTileset); // Also reset the camera view
            });
        }
        
        main();
    </script>
</body>
</html>

