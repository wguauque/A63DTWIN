<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>A63 Digital Twin - 3D Model</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #cesiumContainer { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.5s ease; }
        #headerLogos { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: rgba(255, 255, 255, 0.95); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 1001; height: 70px; box-sizing: border-box; }
        #headerLogos nav { margin: auto; }
        #headerLogos nav a { font-weight: 500; color: #2c3e50; text-decoration: none; padding: 5px 15px; border-radius: 5px; transition: background-color 0.3s; }
        #logoAtlandes, #logoEelisa { height: 50px; }
        .cesium-widget-credits { display: none !important; }
        
        #toolbar { position: absolute; top: 100px; left: 15px; background: rgba(45,45,45,0.9); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; max-width: 280px; color: white; }
        .toolbar-group-label { font-weight: bold; font-size: 0.95em; color: #00bcd4; margin-top: 12px; margin-bottom: 8px; padding-left: 2px; display: block; border-bottom: 1px solid #444; padding-bottom: 3px; }
        .toolbar-group-label:first-child { margin-top: 0; }
        #toolbar input, #toolbar select, #toolbar button { width: calc(100% - 4px); padding: 8px; margin: 4px 2px; border-radius: 4px; border: 1px solid #666; background-color: #333; color: #fff; box-sizing: border-box; }
        #toolbar button { background-color: #444; cursor: pointer; text-align: left; }
        #toolbar button:hover { background-color: #5a5a5a; }
        .filter-item { margin-bottom: 5px; }
        .filter-item label { display: block; font-size: 0.85em; margin-bottom: 2px; color: #ccc; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>
    <div id="loadingOverlay"><h1>Loading Digital Twin...</h1></div>

    <div id="headerLogos">
        <img src="atlandes.jpg" alt="Atlandes Logo" id="logoAtlandes">
        <nav><a href="#">3D Model</a></nav>
        <img src="https://eelisa.eu/wp-content/uploads/2024/07/logo-digital-twins-positive-vertical-color-252x300.png" alt="EELISA Logo" id="logoEelisa">
    </div>

    <div id="toolbar">
        <span class="toolbar-group-label">Search & View</span>
        <input type="text" id="prSearchInput" placeholder="Search by PR (e.g., 45000)">
        <button id="colorizeDateBtn">Toggle Date Colors</button>

        <span class="toolbar-group-label">Filters</span>
        <div id="filter-container"></div>
        <button id="reset-filters-btn">Reset All Filters & View</button>
    </div>

    <script>
        // ===================================================================================
        // --- 1. CENTRAL CONFIGURATION: The single source of truth for your data model ---
        // ===================================================================================
        const CONFIG = {
            filterableProperties: [
                {
                    propertyName: 'ENTREPRISE',
                    displayName: 'Company',
                    type: 'select',
                    options: [
                        'COLAS SO',
                        'GIE A63',
                        'GIE-COLAS SO',
                        'GPT  COLAS-MALLET-SIORAT',
                        'LAFITTE TP',
                        'PRESTATAIRE PREMIER GER'
                    ]
                },
                {
                    propertyName: 'TYPE_COUCH',
                    displayName: 'Layer Type',
                    type: 'select',
                    options: [
                        'Arase',
                        'Base',
                        'couche de forme',
                        'Fondations',
                        'Forme',
                        'Liaison',
                        'Roulement'
                    ]
                },
                {
                    propertyName: 'NÂ°_ORDRE',
                    displayName: 'Order Number',
                    type: 'numeric' // This will be treated as a number
                }
            ],
            search: {
                PR1: 'PR_1',
                PR2: 'PR_2'
            },
            date: {
                propertyName: 'DATE_MS',
                min: -631152000000, // Jan 1, 1950 in milliseconds
                max: 1767225600000, // Jan 1, 2026 in milliseconds
            }
        };

        // --- Global variables for application state
        let myTileset;
        const appState = { filters: {}, searchQuery: '', colorizeByDate: false };

        // ===================================================================================
        // --- 2. CORE LOGIC: Dynamically builds styles based on the CONFIG and appState ---
        // ===================================================================================
        function updateTilesetStyle() {
            if (!myTileset) return;

            // PART A: Build the visibility expression ('show') from filters
            let showConditions = [];
            for (const key in appState.filters) {
                const value = appState.filters[key];
                if (!value) continue; // Skip if filter is empty

                // Find the property's configuration
                const propConfig = CONFIG.filterableProperties.find(p => p.propertyName === key);
                if (!propConfig) continue;

                const propName = propConfig.propertyName;
                const propExpr = /^[a-zA-Z0-9_]+$/.test(propName) ? `\${${propName}}` : `getProperty('${propName}')`;
                
                // IMPORTANT: Correctly format the comparison based on data type
                if (propConfig.type === 'numeric') {
                    showConditions.push(`${propExpr} === ${Number(value)}`); // Numeric comparison
                } else {
                    showConditions.push(`${propExpr} === '${value}'`); // String comparison
                }
            }
            const showExpression = showConditions.length > 0 ? showConditions.join(' && ') : 'true';

            // PART B: Build the color expression
            const dateRange = CONFIG.date.max - CONFIG.date.min;
            const dateColorExpr = `color('red').lerp(color('lime'), (Number(\${${CONFIG.date.propertyName}}) - ${CONFIG.date.min}) / ${dateRange})`;
            
            let colorExpression = appState.colorizeByDate ? dateColorExpr : "color('white')";

            if (appState.searchQuery) {
                const searchCond = `(\${${CONFIG.search.PR1}} === '${appState.searchQuery}') || (\${${CONFIG.search.PR2}} === '${appState.searchQuery}')`;
                colorExpression = `Boolean(${searchCond}) ? color('yellow') : ${colorExpression}`;
            }

            // PART C: Apply the final combined style
            myTileset.style = new Cesium.Cesium3DTileStyle({
                show: showExpression,
                color: colorExpression
            });
        }

        // ===================================================================================
        // --- 3. UI GENERATION: Builds the HTML controls based on the CONFIG object ---
        // ===================================================================================
        function buildFilterUI() {
            const container = document.getElementById('filter-container');
            container.innerHTML = ''; // Clear previous UI

            CONFIG.filterableProperties.forEach(prop => {
                const item = document.createElement('div');
                item.className = 'filter-item';

                const label = document.createElement('label');
                label.htmlFor = `filter-${prop.propertyName}`;
                label.textContent = prop.displayName;
                item.appendChild(label);

                let control;
                if (prop.type === 'select') {
                    control = document.createElement('select');
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = `All ${prop.displayName}s`;
                    control.appendChild(defaultOption);

                    prop.options.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt;
                        option.textContent = opt;
                        control.appendChild(option);
                    });
                } else { // 'string' or 'numeric'
                    control = document.createElement('input');
                    control.type = 'text';
                    control.placeholder = `Enter ${prop.displayName}`;
                }

                control.id = `filter-${prop.propertyName}`;
                control.addEventListener('change', () => {
                    appState.filters[prop.propertyName] = control.value;
                    updateTilesetStyle();
                });

                item.appendChild(control);
                container.appendChild(item);
            });
        }
        
        // ===================================================================================
        // --- 4. MAIN APPLICATION SETUP ---
        // ===================================================================================
        async function main() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            try {
                Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzINIIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyY2I0NzZkYy0zY2E1LTQyZjItOGExMC0xODdhNDFjMzhkNTQiLCJpZCI6MjgzODIyLCJpYXQiOjE3NDE4NDIzNDN9.vKLm9Z15kR3oMQfUkQH5F4vNithJ-vOKHRya8dlHdXY";
                const viewer = new Cesium.Viewer("cesiumContainer", { timeline: false, animation: false, sceneModePicker: false, baseLayerPicker: false, geocoder: true, creditContainer: document.createElement("div"), infoBox: false, selectionIndicator: false });
                viewer.scene.globe.enableLighting = true;

                loadingOverlay.querySelector('h1').textContent = "Loading Terrain...";
                await Cesium.createWorldTerrainAsync().then(tp => { viewer.scene.terrainProvider = tp; });

                loadingOverlay.querySelector('h1').textContent = "Loading 3D Model...";
                myTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3672505);
                viewer.scene.primitives.add(myTileset);
                
                // Dynamically build UI controls from the CONFIG
                buildFilterUI();
                // Set up event listeners for non-dynamic controls
                setupEventListeners();

                updateTilesetStyle(); // Apply initial style

                loadingOverlay.querySelector('h1').textContent = "Positioning Camera...";
                await viewer.zoomTo(myTileset);
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);

            } catch (error) {
                console.error("Critical error during Cesium setup:", error);
                loadingOverlay.querySelector('h1').textContent = `Application Error: ${error.message}`;
            }
        }

        function setupEventListeners() {
            document.getElementById('prSearchInput').addEventListener('input', (event) => {
                appState.searchQuery = event.target.value;
                updateTilesetStyle();
            });

            document.getElementById('colorizeDateBtn').addEventListener('click', () => {
                appState.colorizeByDate = !appState.colorizeByDate;
                updateTilesetStyle();
            });

            document.getElementById('reset-filters-btn').addEventListener('click', () => {
                // Reset state
                appState.filters = {};
                appState.searchQuery = '';
                appState.colorizeByDate = false;
                
                // Reset UI
                document.getElementById('prSearchInput').value = '';
                document.querySelectorAll('#filter-container select, #filter-container input').forEach(el => el.value = '');
                
                updateTilesetStyle();
            });
        }
        
        // --- Run the application ---
        main();

    </script>
</body>
</html>
