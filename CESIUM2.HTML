<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>A63 Digital Twin - 3D Model</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        #cesiumContainer { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.5s ease; }
        #headerLogos { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: rgba(255, 255, 255, 0.95); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 1001; height: 70px; box-sizing: border-box; }
        #logoAtlandes, #logoEelisa { height: 45px; width: auto; }
        .cesium-widget-credits { display: none !important; }

        /* Styles for new navigation buttons */
        .main-nav { display: flex; gap: 10px; }
        .main-nav a { padding: 8px 16px; text-decoration: none; color: #212121; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 6px; font-weight: 500; transition: all 0.2s ease-in-out; }
        .main-nav a:hover { background-color: #e0e0e0; border-color: #aaa; }
        .main-nav a.active { background-color: #00bcd4; color: white; border-color: #008fa1; }
        
        #toolbar { position: absolute; top: 100px; left: 15px; background: rgba(35,35,35,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; max-width: 280px; color: white; }
        .toolbar-group-label { font-weight: bold; font-size: 0.95em; color: #00bcd4; margin-top: 12px; margin-bottom: 8px; padding-left: 2px; display: block; border-bottom: 1px solid #444; padding-bottom: 3px; }
        #toolbar input, #toolbar select, #toolbar button { width: calc(100% - 4px); padding: 8px; margin: 4px 2px; border-radius: 4px; border: 1px solid #666; background-color: #333; color: #fff; box-sizing: border-box; }
        #toolbar button { background-color: #444; cursor: pointer; text-align: left; }

        .pr-search-container { position: relative; }
        #autocomplete-results { position: absolute; top: 100%; left: 2px; right: 2px; background: #3a3a3a; border: 1px solid #777; border-top: none; border-radius: 0 0 4px 4px; z-index: 1002; max-height: 200px; overflow-y: auto; }
        .autocomplete-item { padding: 8px; color: #fff; cursor: pointer; }
        .autocomplete-item:hover { background-color: #555; }
        #infobox { position: absolute; bottom: 20px; right: 20px; background: rgba(35, 35, 35, 0.9); color: white; padding: 12px; border-radius: 8px; display: none; max-width: 320px; border: 1px solid #666; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 1000; font-size: 0.9em; }
        #infobox h3 { margin-top: 0; padding-bottom: 5px; border-bottom: 1px solid #555; color: #00bcd4; }
        #infobox table { width: 100%; border-collapse: collapse; }
        #infobox th, #infobox td { padding: 5px 2px; text-align: left; }
        #infobox th { font-weight: bold; color: #ccc; width: 40%; }
        
        #date-ramp-banner, #typecouch-ramp-banner { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(35, 35, 35, 0.9); color: white; padding: 15px; border-radius: 8px; border: 1px solid #666; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 1001; display: none; flex-direction: column; align-items: center; width: auto; min-width: 350px; }
        #date-ramp-banner h3, #typecouch-ramp-banner h3 { margin: 0 0 10px 0; color: #00bcd4; }
        #date-ramp-legend, #typecouch-ramp-legend { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; font-size: 0.85em; justify-content: center;}
        .legend-item { display: flex; align-items: center; }
        .color-box { width: 15px; height: 15px; margin-right: 5px; border: 1px solid #888; }
        #date-ramp-controls, #typecouch-ramp-controls { display: flex; gap: 10px; width: 100%; margin-top: 5px; }
        #date-ramp-controls button, #typecouch-ramp-controls button { width: 50%; text-align: center; }
        
        #inspection-toolbar { position: absolute; top: 100px; right: 15px; background: rgba(35,35,35,0.95); padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 1000; width: 240px; color: white; }
        #inspection-toolbar .toolbar-group-label { color: #ff9800; }
        #inspection-toolbar button { width: calc(100% - 4px); padding: 8px; margin: 4px 2px; border-radius: 4px; border: 1px solid #666; background-color: #444; color: #fff; box-sizing: border-box; cursor: pointer; text-align: left; }
        
        #mode-notification { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(35, 35, 35, 0.9); color: white; padding: 20px 40px; border-radius: 10px; font-size: 1.2em; text-align: center; font-weight: bold; z-index: 10000; display: none; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
    </style>
</head>
<body>

    <div id="cesiumContainer"></div>
    <div id="loadingOverlay"><h1>Loading Digital Twin...</h1></div>
    <div id="mode-notification">Inspection Mode</div>

    <div id="infobox"></div>

    <div id="headerLogos">
        <img src="atlandes.jpg" alt="Atlandes Logo" id="logoAtlandes">
        <nav class="main-nav">
            <a href="index.html">Home</a>
            <a href="cesium.html" class="active">3D Model</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="map.html">ArcGIS Map</a>
        </nav>
        <img src="https://www.digitwin4ciue.eu/wp-content/uploads/2025/01/COEv2.png" alt="EELISA Logo" id="logoEelisa">
    </div>

    <div id="toolbar">
        <span class="toolbar-group-label">Basemap</span>
        <select id="basemap-picker">
            <option value="imagery" selected>Satellite Imagery</option>
            <option value="photorealistic">3D Photorealistic</option>
        </select>
        
        <span class="toolbar-group-label">Tools</span>
        <button id="measure-btn">Activate Measurement Tool</button>
        <button id="show-date-ramp-btn">Intervention Date Ramp</button>
        
        <span class="toolbar-group-label">Navigate Sections (by dataLayer)</span>
        <div class="pr-search-container">
            <input type="text" id="pr-search" placeholder="Search Section (e.g., 83)">
            <div id="autocomplete-results"></div>
        </div>
        <div id="navigation-controls" style="display: flex; justify-content: space-between; margin-top: 8px;">
            <button id="prev-pr-btn" style="width: 48%; text-align: center;">&lt; Prev Section</button>
            <button id="next-pr-btn" style="width: 48%; text-align: center;">Next Section &gt;</button>
        </div>

        <span class="toolbar-group-label">Filter by Company (Asset 1)</span>
        <select id="entreprise-filter"></select>
        
        <span class="toolbar-group-label">Layer Analysis (Asset 1)</span>
        <button id="show-typecouch-ramp-btn">Colorize by Layer Type</button>
        
        <button id="reset-btn" style="margin-top: 10px;">Reset View</button>
    </div>

    <div id="inspection-toolbar">
        <span class="toolbar-group-label">Inspection Mode (Asset 1)</span>
        <p style="font-size: 0.8em; padding: 0 4px 4px; margin: 0; color: #ccc;">Isolates a section for detailed review.</p>
        <button id="clip-btn">Activate Clipping Tool</button>
        <button id="clear-clips-btn">Exit Inspection & Clear</button>
    </div>

    <div id="date-ramp-banner">
        <h3>Intervention Date Colour Ramp</h3>
        <div id="date-ramp-legend">
            <div class="legend-item"><span class="color-box" style="background-color: green;"></span> 2020+</div>
            <div class="legend-item"><span class="color-box" style="background-color: lime;"></span> 2010-2019</div>
            <div class="legend-item"><span class="color-box" style="background-color: yellow;"></span> 2000-2009</div>
            <div class="legend-item"><span class="color-box" style="background-color: red;"></span> &lt; 2000</div>
            <div class="legend-item"><span class="color-box" style="background-color: gray;"></span> No Data</div>
        </div>
        <div id="date-ramp-controls">
            <button id="apply-date-ramp-btn">Apply Ramp</button>
            <button id="close-date-ramp-btn">Close</button>
        </div>
    </div>
    
    <div id="typecouch-ramp-banner">
        <h3>Layer Type (TYPECOUCH)</h3>
        <div id="typecouch-ramp-legend"></div>
        <div id="typecouch-ramp-controls">
            <button id="apply-typecouch-ramp-btn">Apply Colorization</button>
            <button id="close-typecouch-ramp-btn">Close & Reset Style</button>
        </div>
    </div>


    <script>
        const companyList = [ 'COLAS SO', 'GIE A63', 'GIE-COLAS SO', 'GPT  COLAS-MALLET-SIORAT', 'LAFITTE TP', 'PRESTATAIRE PREMIER GER' ];
        
        const prList = [];
        for (let i = 34; i <= 140; i++) { prList.push(i.toString()); }

        const dataLayerPrList = [];
        for (let i = 80; i <= 95; i++) { dataLayerPrList.push(i.toString()); }

        const allowedProperties = ['TYPECOUCH', 'SURFACE', 'ENTREPRISE', 'PR1', 'NORDRE', 'CHANTIER', 'FOND', 'PR2', 'DATEMS', 'dataLayer'];

        const typeCouchMap = {
            'Roulement':     { color: Cesium.Color.fromCssColorString('#4A4A4A'), label: 'Wearing Course' },
            'Liaison':       { color: Cesium.Color.fromCssColorString('#6E6E6E'), label: 'Binding Course' },
            'Base':          { color: Cesium.Color.fromCssColorString('#8B4513'), label: 'Base Course' },
            'Arase':         { color: Cesium.Color.fromCssColorString('#B0C4DE'), label: 'Leveling Course' },
            'Fondations':    { color: Cesium.Color.fromCssColorString('#A0522D'), label: 'Foundation' },
            'Forme':         { color: Cesium.Color.fromCssColorString('#D2B48C'), label: 'Subgrade' },
            'couche de forme':{ color: Cesium.Color.fromCssColorString('#D2B48C'), label: 'Subgrade' },
            'blank':         { color: Cesium.Color.LIGHTSLATEGRAY, label: 'Not Specified' }
        };

        let myTileset, secondTileset, defaultStyle, viewer, photorealisticTileset, defaultImageryLayer;
        let selectedFeature = undefined;
        let originalColor = new Cesium.Color();
        const highlightColor = Cesium.Color.AQUA;
        
        let isMeasuring = false;
        let measurementDataSource, measurementHandler;
        
        let isClipping = false;
        let clippingDataSource, clippingHandler;
        let originalGlobeShow = true;
        let originalPhotoTilesShow = false;

        const appState = { entrepriseFilter: '', prSearch: '', currentPrIndex: -1, currentDataLayerPrIndex: -1, isDateViewActive: false, isTypeCouchViewActive: false };

        function getMaterialColor(material) { const upperMaterial = material.toUpperCase(); if (upperMaterial.includes('BBSG') || upperMaterial.includes('BBTM') || upperMaterial.includes('BBME') || upperMaterial.includes('EME') || upperMaterial.includes('BBDR') || upperMaterial.includes('ACCOUSTIQ') || upperMaterial.includes('ACC')) { return Cesium.Color.DIMGRAY.toCssColorString(); } if (upperMaterial.includes('GB') || upperMaterial.includes('GNT')) { return Cesium.Color.GRAY.toCssColorString(); } if (upperMaterial.includes('SB') || upperMaterial.includes('GTLH') || upperMaterial.includes('FORME')) { return Cesium.Color.BURLYWOOD.toCssColorString(); } if (upperMaterial.includes('BET') || upperMaterial.includes('CBX')) { return Cesium.Color.LIGHTGRAY.toCssColorString(); } if (upperMaterial.includes('GEOTEXTILE')) { return Cesium.Color.WHITESMOKE.toCssColorString(); } if (upperMaterial.includes('ETANCH')) { return Cesium.Color.STEELBLUE.toCssColorString(); } return Cesium.Color.DIMGRAY.toCssColorString(); }

        function applyDateStyle() {
            if (!myTileset) return;
            myTileset.style = new Cesium.Cesium3DTileStyle({
                color: {
                    conditions: [
                        ["regExp('^202').test(String(${excelLayerInfoDATEMS}))", "color('green')"],
                        ["regExp('^201').test(String(${excelLayerInfoDATEMS}))", "color('lime')"],
                        ["regExp('^200').test(String(${excelLayerInfoDATEMS}))", "color('yellow')"],
                        ["regExp('^19').test(String(${excelLayerInfoDATEMS}))", "color('red')"],
                        ["true", "color('gray')"]
                    ]
                }
            });
            viewer.scene.requestRender();
        }

        function applyTypeCouchStyle() {
            if (!myTileset) return;
            const conditions = Object.entries(typeCouchMap).flatMap(([key, value]) => {
                const colorStr = `color('${value.color.toCssColorString()}')`;
                if (key === 'blank') {
                    return [["!(${excelLayerInfoTYPECOUCH})", colorStr]];
                } else {
                    return [[`\${excelLayerInfoTYPECOUCH} === '${key}'`, colorStr]];
                }
            });
            conditions.push(["true", "color('white')"]);
            myTileset.style = new Cesium.Cesium3DTileStyle({ color: { conditions: conditions } });
            viewer.scene.requestRender();
        }

        function updateTilesetStyle() {
            if (appState.isDateViewActive) { applyDateStyle(); return; }
            if (appState.isTypeCouchViewActive) { applyTypeCouchStyle(); return; }
            if (!myTileset || !defaultStyle) return;
            let showConditions = [];
            if (appState.entrepriseFilter) {
                showConditions.push(`\${excelLayerInfoENTREPRISE} === '${appState.entrepriseFilter}'`);
            }
            const showExpression = showConditions.length > 0 ? showConditions.join(' && ') : 'true';
            myTileset.style = new Cesium.Cesium3DTileStyle({ show: showExpression, color: defaultStyle.color.expression });
            viewer.scene.requestRender();
        }
        
        function calculateCentroid(points) {
            let sum = new Cesium.Cartesian3(0, 0, 0);
            points.forEach(p => {
                Cesium.Cartesian3.add(sum, p, sum);
            });
            return Cesium.Cartesian3.divideByScalar(sum, points.length, new Cesium.Cartesian3());
        }

        async function main() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            try {
                Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjOWE1NDNmOC02MzkxLTQyMWUtODFiOC1iYzMwZTZkMjg0OTUiLCJpZCI6MjgzODIyLCJpYXQiOjE3NTcxMjM2OTN9.SLvGBcu3zALbkrbRqQZS4KRrn960cXEbpW-7xWIavCY";
                viewer = new Cesium.Viewer("cesiumContainer", { timeline: false, animation: false, sceneModePicker: false, baseLayer: false, geocoder: true, creditContainer: document.createElement("div"), infoBox: false, selectionIndicator: false, requestRenderMode: true, maximumRenderTimeChange: Infinity });
                viewer.scene.globe.enableLighting = true;
                viewer.scene.fog.enabled = true;
                viewer.scene.fog.density = 0.0002;
                viewer.scene.screenSpaceCameraController.minimumZoomDistance = 100;
                
                defaultImageryLayer = viewer.scene.imageryLayers.addImageryProvider(await Cesium.createWorldImageryAsync());
                
                loadingOverlay.querySelector('h1').textContent = "Loading Basemap...";
                try { photorealisticTileset = await Cesium.createGooglePhotorealistic3DTileset(); viewer.scene.primitives.add(photorealisticTileset); photorealisticTileset.show = false; } catch (error) { console.error("Could not load Google Photorealistic 3D Tiles:", error); document.getElementById('basemap-picker').disabled = true; }

                loadingOverlay.querySelector('h1').textContent = "Loading Terrain...";
                viewer.terrainProvider = await Cesium.CesiumTerrainProvider.fromIonAssetId(3693677);

                loadingOverlay.querySelector('h1').textContent = "Loading 3D Model (Asset 1)...";
                myTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3694449); 
                viewer.scene.primitives.add(myTileset);
                await myTileset.readyPromise;

                const heightOffset = 50.0;
                const cartographic = Cesium.Cartographic.fromCartesian(myTileset.boundingSphere.center);
                const surface = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, 0.0);
                const offset = Cesium.Cartesian3.fromRadians(cartographic.longitude, cartographic.latitude, heightOffset);
                const translation = Cesium.Cartesian3.subtract(offset, surface, new Cesium.Cartesian3());
                myTileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation);

                defaultStyle = new Cesium.Cesium3DTileStyle({ color: "color('DIMGRAY')" });
                myTileset.style = defaultStyle;
                myTileset.clippingPolygons = new Cesium.ClippingPolygonCollection({ edgeWidth: 1.0, edgeColor: Cesium.Color.WHITE });

                loadingOverlay.querySelector('h1').textContent = "Loading 3D Model (Asset 2)...";
                secondTileset = await Cesium.Cesium3DTileset.fromIonAssetId(3694630);
                viewer.scene.primitives.add(secondTileset);
                await secondTileset.readyPromise;

                const heightOffset2 = 50.0;
                const cartographic2 = Cesium.Cartographic.fromCartesian(secondTileset.boundingSphere.center);
                const surface2 = Cesium.Cartesian3.fromRadians(cartographic2.longitude, cartographic2.latitude, 0.0);
                const offset2 = Cesium.Cartesian3.fromRadians(cartographic2.longitude, cartographic2.latitude, heightOffset2);
                const translation2 = Cesium.Cartesian3.subtract(offset2, surface2, new Cesium.Cartesian3());
                secondTileset.modelMatrix = Cesium.Matrix4.fromTranslation(translation2);

                measurementDataSource = new Cesium.CustomDataSource('measurementDataSource');
                viewer.dataSources.add(measurementDataSource);
                clippingDataSource = new Cesium.CustomDataSource('clippingDataSource');
                viewer.dataSources.add(clippingDataSource);

                buildEntrepriseFilterUI();
                buildTypeCouchLegendUI();
                setupEventListeners();

                loadingOverlay.querySelector('h1').textContent = "Positioning Camera...";
                await viewer.zoomTo(myTileset);
                loadingOverlay.style.opacity = '0';
                setTimeout(() => { loadingOverlay.style.display = 'none'; }, 500);
            } catch (error) { console.error("Critical error during Cesium setup:", error); loadingOverlay.querySelector('h1').textContent = `Application Error: ${error.message}`; }
        }

        function buildEntrepriseFilterUI() { const select = document.getElementById('entreprise-filter'); select.innerHTML = ''; const allOption = document.createElement('option'); allOption.value = ''; allOption.textContent = 'Show All Companies'; select.appendChild(allOption); companyList.forEach(company => { const option = document.createElement('option'); option.value = company; option.textContent = company; select.appendChild(option); }); }
        
        function buildTypeCouchLegendUI() {
            const legendContainer = document.getElementById('typecouch-ramp-legend');
            legendContainer.innerHTML = '';
            for (const key in typeCouchMap) {
                const item = typeCouchMap[key];
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `<span class="color-box" style="background-color: ${item.color.toCssColorString()};"></span> ${item.label}`;
                legendContainer.appendChild(legendItem);
            }
        }
        
        // --- MODIFIED: This function now uses the two-step zoom-and-pick method ---
        function navigateToDataLayerSection(prString) {
            if (!secondTileset || !viewer || !prString) return;
            const prNumber = Number(prString);
            if (isNaN(prNumber)) return;

            // Update state and UI
            appState.currentDataLayerPrIndex = dataLayerPrList.indexOf(prString);
            document.getElementById('pr-search').value = prString;
            document.getElementById('autocomplete-results').innerHTML = '';

            // Step 1: Apply the style to show only the desired section
            secondTileset.style = new Cesium.Cesium3DTileStyle({
                show: `Math.floor(Number(\${dataLayer}) / 1000) === ${prNumber}`
            });

            // Step 2: Perform a rough zoom to get the section in view
            viewer.zoomTo(secondTileset)
                .then(() => {
                    // Step 3: Find the 3D point at the center of the screen
                    const canvas = viewer.scene.canvas;
                    const center = new Cesium.Cartesian2(canvas.clientWidth / 2, canvas.clientHeight / 2);
                    const centerPoint = viewer.scene.pickPosition(center);

                    if (Cesium.defined(centerPoint)) {
                        // Step 4: We found a point! Now execute a smooth flight for a clean "lookAt" view.
                        viewer.camera.flyTo({
                            destination: centerPoint,
                            orientation: {
                                heading: Cesium.Math.toRadians(0.0), // Look North
                                pitch: Cesium.Math.toRadians(-60.0), // Look down at a 60-degree angle
                                roll: 0.0
                            },
                            // Move the camera so it's 2000 meters away from the point
                            endTransform: Cesium.Matrix4.fromTranslation(new Cesium.Cartesian3(0, 0, -2000)),
                            duration: 1.5 // seconds
                        });
                    } else {
                        // Fallback if the pick failed; the section might be too small or off-center
                        console.warn("Could not find a center point for the selected section.");
                    }
                    
                    // Finally, reset the style so the whole model becomes visible again from the new view
                    secondTileset.style = new Cesium.Cesium3DTileStyle();
                }).catch((error) => {
                    console.error("Error during zoom-to-pick operation:", error);
                    // Ensure style is reset on error
                    secondTileset.style = new Cesium.Cesium3DTileStyle();
                });
        }
        
        function displayFeatureInfo(feature) { const infobox = document.getElementById('infobox'); const propertyIds = feature.getPropertyIds(); let content = '<h3>Selected Feature</h3><table>'; for (let i = 0; i < propertyIds.length; i++) { const propName = propertyIds[i]; let displayName = propName.replace('excelLayerInfo', ''); if (allowedProperties.includes(displayName.toUpperCase()) || propName === "dataLayer") { displayName = (propName === "dataLayer") ? "dataLayer" : displayName; let propValue = feature.getProperty(propName); if (displayName.toUpperCase() === 'DATEMS' && propValue) { propValue = propValue.split(' ')[0]; } propValue = (propValue === null || propValue === undefined) ? "N/A" : propValue; content += `<tr><th>${displayName}</th><td>${propValue}</td></tr>`; } } content += '</table>'; infobox.innerHTML = content; infobox.style.display = 'block'; }
        
        function activateMeasurement() { isMeasuring = true; document.getElementById('measure-btn').textContent = 'Deactivate Measurement (Right-click)'; document.getElementById('measure-btn').style.backgroundColor = '#00bcd4'; measurementHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas); let positions = []; let totalDistance = 0; let dynamicLine, distanceLabel; measurementHandler.setInputAction(function (movement) { if (positions.length === 0) return; const cartesian = viewer.scene.pickPosition(movement.endPosition); if (!Cesium.defined(cartesian)) return; if (!Cesium.defined(dynamicLine)) { dynamicLine = measurementDataSource.entities.add({ polyline: { positions: new Cesium.CallbackProperty(() => [positions[positions.length - 1], cartesian], false), width: 2, material: Cesium.Color.YELLOW } }); } const segmentDistance = Cesium.Cartesian3.distance(positions[positions.length - 1], cartesian); distanceLabel.position = cartesian; distanceLabel.label.text = `Total: ${(totalDistance + segmentDistance).toFixed(2)} m`; }, Cesium.ScreenSpaceEventType.MOUSE_MOVE); measurementHandler.setInputAction(function (click) { const cartesian = viewer.scene.pickPosition(click.position); if (!Cesium.defined(cartesian)) return; positions.push(cartesian); if (positions.length > 1) { const lastPoint = positions[positions.length - 2]; totalDistance += Cesium.Cartesian3.distance(lastPoint, cartesian); measurementDataSource.entities.add({ polyline: { positions: [lastPoint, cartesian], width: 3, material: Cesium.Color.ORANGERED } }); } measurementDataSource.entities.add({ position: cartesian, point: { pixelSize: 8, color: Cesium.Color.ORANGERED } }); if (!Cesium.defined(distanceLabel)) { distanceLabel = measurementDataSource.entities.add({ position: cartesian, label: { text: 'Start', font: '14pt monospace', style: Cesium.LabelStyle.FILL_AND_OUTLINE, outlineWidth: 2, verticalOrigin: Cesium.VerticalOrigin.BOTTOM, pixelOffset: new Cesium.Cartesian2(0, -9) } }); } }, Cesium.ScreenSpaceEventType.LEFT_CLICK); measurementHandler.setInputAction(() => deactivateMeasurement(), Cesium.ScreenSpaceEventType.RIGHT_CLICK); }
        function deactivateMeasurement() { isMeasuring = false; if (Cesium.defined(measurementHandler)) { measurementHandler.destroy(); measurementHandler = undefined; } measurementDataSource.entities.removeAll(); document.getElementById('measure-btn').textContent = 'Activate Measurement Tool'; document.getElementById('measure-btn').style.backgroundColor = '#444'; viewer.scene.requestRender(); }
        
        function activateClippingTool() {
            const notification = document.getElementById('mode-notification');
            notification.textContent = 'Click on the model to delineate the section. Right-click when complete.';
            notification.style.display = 'block';
            setTimeout(() => { notification.style.opacity = '1'; }, 10);
            setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => { notification.style.display = 'none'; notification.textContent = 'Inspection Mode'; }, 500); }, 3500);

            isClipping = true;
            const clipBtn = document.getElementById('clip-btn');
            clipBtn.textContent = 'Drawing... (Right-click to finish)';
            clipBtn.style.backgroundColor = '#ff9800';
            clippingHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            let points = [];
            let polygonEntity = null;

            clippingHandler.setInputAction(function(click) {
                const cartesian = viewer.scene.pickPosition(click.position);
                if (Cesium.defined(cartesian)) {
                    points.push(cartesian.clone());
                    clippingDataSource.entities.add({ position: cartesian, point: { pixelSize: 8, color: Cesium.Color.WHITE } });
                }
            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            clippingHandler.setInputAction(function(movement) {
                if (points.length < 1) return;
                const cartesian = viewer.scene.pickPosition(movement.endPosition);
                if (Cesium.defined(cartesian)) {
                    if (polygonEntity === null) {
                        polygonEntity = clippingDataSource.entities.add({
                            polygon: {
                                hierarchy: new Cesium.CallbackProperty(() => new Cesium.PolygonHierarchy(points.concat(cartesian)), false),
                                material: Cesium.Color.WHITE.withAlpha(0.3),
                                outline: true,
                                outlineColor: Cesium.Color.WHITE
                            }
                        });
                    }
                }
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
            
            clippingHandler.setInputAction(function() {
                if (points.length >= 3) {
                    const notification = document.getElementById('mode-notification');
                    notification.textContent = 'Inspection Mode';
                    notification.style.display = 'block';
                    setTimeout(() => { notification.style.opacity = '1'; }, 10);
                    setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => { notification.style.display = 'none'; }, 500); }, 2000);

                    appState.isDateViewActive = true;
                    applyDateStyle();
                    document.getElementById('date-ramp-banner').style.display = 'flex';
                    originalGlobeShow = viewer.scene.globe.show;
                    viewer.scene.globe.show = false;
                    if (photorealisticTileset) {
                        originalPhotoTilesShow = photorealisticTileset.show;
                        photorealisticTileset.show = false;
                    }

                    const offsetDistance = 5.0; 
                    const centroid = calculateCentroid(points);
                    const offsetPoints = points.map(p => {
                        const direction = Cesium.Cartesian3.subtract(p, centroid, new Cesium.Cartesian3());
                        Cesium.Cartesian3.normalize(direction, direction);
                        const offsetVector = Cesium.Cartesian3.multiplyByScalar(direction, offsetDistance, new Cesium.Cartesian3());
                        return Cesium.Cartesian3.add(p, offsetVector, new Cesium.Cartesian3());
                    });

                    const newClippingPolygon = new Cesium.ClippingPolygon({
                        positions: offsetPoints
                    });
                    myTileset.clippingPolygons.add(newClippingPolygon);
                }
                deactivateClippingDrawing(); 
            }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);
        }

        function deactivateClippingDrawing() {
            isClipping = false;
            if (clippingHandler) {
                clippingHandler.destroy();
                clippingHandler = undefined;
            }
            clippingDataSource.entities.removeAll();
            const clipBtn = document.getElementById('clip-btn');
            clipBtn.textContent = 'Activate Clipping Tool';
            clipBtn.style.backgroundColor = '#444';
            viewer.scene.requestRender();
        }

        function clearClippingPlanes() {
            if (isClipping) deactivateClippingDrawing();
            if (myTileset && myTileset.clippingPolygons) {
                myTileset.clippingPolygons.removeAll();
            }
            viewer.scene.globe.show = originalGlobeShow;
            if (photorealisticTileset) {
                photorealisticTileset.show = originalPhotoTilesShow;
            }
            deactivateDateView(); 
        }
        
        function deactivateDateView() { appState.isDateViewActive = false; document.getElementById('date-ramp-banner').style.display = 'none'; updateTilesetStyle(); }
        function deactivateTypeCouchView() { appState.isTypeCouchViewActive = false; document.getElementById('typecouch-ramp-banner').style.display = 'none'; updateTilesetStyle(); }
        function deactivateAllModes() { deactivateDateView(); deactivateTypeCouchView(); }
        
        function setupEventListeners() {
            const selectionHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            selectionHandler.setInputAction(function (movement) { if (isMeasuring || isClipping) return; if (Cesium.defined(selectedFeature)) { selectedFeature.color = originalColor; selectedFeature = undefined; } const pickedFeature = viewer.scene.pick(movement.position); const infobox = document.getElementById('infobox'); if (pickedFeature instanceof Cesium.Cesium3DTileFeature) { selectedFeature = pickedFeature; Cesium.Color.clone(selectedFeature.color, originalColor); selectedFeature.color = highlightColor; displayFeatureInfo(pickedFeature); } else { infobox.style.display = 'none'; } viewer.scene.requestRender(); }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

            document.getElementById('measure-btn').addEventListener('click', () => { if (isMeasuring) { deactivateMeasurement(); } else { clearClippingPlanes(); deactivateAllModes(); activateMeasurement(); } });
            document.getElementById('show-date-ramp-btn').addEventListener('click', () => { clearClippingPlanes(); deactivateAllModes(); document.getElementById('date-ramp-banner').style.display = 'flex'; });
            document.getElementById('apply-date-ramp-btn').addEventListener('click', () => { deactivateTypeCouchView(); appState.isDateViewActive = true; if(isClipping) deactivateClippingDrawing(); deactivateMeasurement(); updateTilesetStyle(); });
            document.getElementById('close-date-ramp-btn').addEventListener('click', () => { deactivateDateView(); });

            document.getElementById('show-typecouch-ramp-btn').addEventListener('click', () => { clearClippingPlanes(); deactivateAllModes(); document.getElementById('typecouch-ramp-banner').style.display = 'flex'; });
            document.getElementById('apply-typecouch-ramp-btn').addEventListener('click', () => { deactivateDateView(); appState.isTypeCouchViewActive = true; if(isClipping) deactivateClippingDrawing(); deactivateMeasurement(); updateTilesetStyle(); });
            document.getElementById('close-typecouch-ramp-btn').addEventListener('click', () => { deactivateTypeCouchView(); });

            document.getElementById('clip-btn').addEventListener('click', () => { if (isClipping) { deactivateClippingDrawing(); } else { clearClippingPlanes(); deactivateAllModes(); deactivateMeasurement(); activateClippingTool(); } });
            document.getElementById('clear-clips-btn').addEventListener('click', clearClippingPlanes);

            document.getElementById('basemap-picker').addEventListener('change', (event) => { const selectedBasemap = event.target.value; if (selectedBasemap === 'photorealistic') { if(photorealisticTileset) photorealisticTileset.show = true; defaultImageryLayer.show = false; viewer.scene.globe.baseColor = Cesium.Color.BLACK; originalPhotoTilesShow = true; } else { if(photorealisticTileset) photorealisticTileset.show = false; defaultImageryLayer.show = true; viewer.scene.globe.baseColor = Cesium.Color.TRANSPARENT; originalPhotoTilesShow = false; } viewer.scene.requestRender(); });
            
            document.getElementById('pr-search').addEventListener('input', (e) => {
                const value = e.target.value.toLowerCase();
                const autocompleteResults = document.getElementById('autocomplete-results');
                autocompleteResults.innerHTML = '';
                if (!value) return;

                const filteredPRs = dataLayerPrList.filter(pr => pr.toLowerCase().startsWith(value));

                filteredPRs.forEach(pr => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.textContent = pr;
                    item.addEventListener('click', () => navigateToDataLayerSection(pr));
                    autocompleteResults.appendChild(item);
                });
            });

            document.getElementById('prev-pr-btn').addEventListener('click', () => {
                if (appState.currentDataLayerPrIndex > 0) {
                    navigateToDataLayerSection(dataLayerPrList[appState.currentDataLayerPrIndex - 1]);
                }
            });

            document.getElementById('next-pr-btn').addEventListener('click', () => {
                if (appState.currentDataLayerPrIndex < dataLayerPrList.length - 1 && appState.currentDataLayerPrIndex > -1) {
                    navigateToDataLayerSection(dataLayerPrList[appState.currentDataLayerPrIndex + 1]);
                }
            });

            document.getElementById('entreprise-filter').addEventListener('change', () => { clearClippingPlanes(); deactivateAllModes(); appState.entrepriseFilter = document.getElementById('entreprise-filter').value; updateTilesetStyle(); });
            
            document.getElementById('reset-btn').addEventListener('click', () => { 
                deactivateMeasurement(); 
                clearClippingPlanes();
                deactivateAllModes();
                document.getElementById('entreprise-filter').value = ''; 
                document.getElementById('pr-search').value = ''; 
                document.getElementById('autocomplete-results').innerHTML = ''; 
                appState.entrepriseFilter = ''; 
                appState.prSearch = ''; 
                appState.currentPrIndex = -1;
                appState.currentDataLayerPrIndex = -1; 
                myTileset.style = defaultStyle; 
                if (secondTileset) {
                    secondTileset.style = new Cesium.Cesium3DTileStyle();
                }
                viewer.zoomTo(myTileset); 
            });
        }
        
        main();
    </script>
</body>
</html>
