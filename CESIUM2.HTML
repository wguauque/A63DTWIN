<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>A63 Digital Twin - 3D Model</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; }
        #cesiumContainer { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
        #loadingOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30,30,30,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; color: white; transition: opacity 0.5s ease; }
        #headerLogos { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: rgba(255, 255, 255, 0.95); border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); z-index: 1001; height: 70px; box-sizing: border-box; }
        #logoAtlandes, #logoEelisa { height: 50px; }
        #toolbar { position: absolute; top: 100px; left: 15px; background: rgba(45,45,45,0.9); padding: 10px; border-radius: 8px; max-width: 280px; color: white; z-index: 1000; }
        .toolbar-group-label { font-weight: bold; font-size: 0.95em; color: #00bcd4; margin-top: 12px; margin-bottom: 8px; padding-left: 2px; display: block; border-bottom: 1px solid #444; padding-bottom: 3px; }
        #toolbar input, #toolbar select, #toolbar button { width: calc(100% - 4px); padding: 8px; margin: 4px 2px; border-radius: 4px; border: 1px solid #666; background-color: #333; color: #fff; }
        #toolbar button:hover { background-color: #5a5a5a; }
    </style>
</head>
<body>

<div id="cesiumContainer"></div>
<div id="loadingOverlay"><h1>Loading Digital Twin...</h1></div>

<div id="headerLogos">
    <img src="atlandes.jpg" alt="Atlandes Logo" id="logoAtlandes">
    <nav><a href="#">3D Model</a></nav>
    <img src="https://eelisa.eu/wp-content/uploads/2024/07/logo-digital-twins-positive-vertical-color-252x300.png" alt="EELISA Logo" id="logoEelisa">
</div>

<div id="toolbar">
    <span class="toolbar-group-label">Search & View</span>
    <input type="text" id="prSearchInput" placeholder="Search by PR (e.g., 198110)">
    <button id="colorizeDateBtn">Toggle Date Colors</button>

    <span class="toolbar-group-label">Filters</span>
    <div id="filter-container"></div>
    <button id="reset-filters-btn">Reset All Filters & View</button>
</div>

<script>
    const CONFIG = {
        filterableProperties: [
            {
                propertyName: 'excelLayerInfoENTREPRISE',
                displayName: 'Company',
                type: 'select',
                options: ['COLAS SO', 'GIE A63', 'GIE-COLAS SO', 'GPT  COLAS-MALLET-SIORAT', 'LAFITTE TP', 'PRESTATAIRE PREMIER GER']
            },
            {
                propertyName: 'excelLayerInfoTYPE_COUCH',
                displayName: 'Layer Type',
                type: 'select',
                options: ['Arase', 'Base', 'couche de forme', 'Fondations', 'Forme', 'Liaison', 'Roulement']
            },
            {
                propertyName: 'excelLayerInfoNÂ°_ORDRE',
                displayName: 'Order Number',
                type: 'numeric'
            },
            {
                propertyName: 'corridorModelInformationRegionName',
                displayName: 'Region Name',
                type: 'numeric'
            }
        ],
        search: {
            PR1: 'excelLayerInfoPR1',
            PR2: 'excelLayerInfoPR2'
        },
        date: {
            propertyName: 'excelLayerInfoDATEMS',
            min: 1950,
            max: 2025
        }
    };

    const appState = { filters: {}, searchQuery: '', colorizeByDate: false };
    let myTileset;

    const viewer = new Cesium.Viewer('cesiumContainer', {
        timeline: false, animation: false, baseLayerPicker: false, navigationHelpButton: false,
        geocoder: false, homeButton: false, infoBox: false, sceneModePicker: false, selectionIndicator: false
    });

    window.viewer = viewer;

    async function loadTileset() {
        myTileset = await Cesium.Cesium3DTileset.fromUrl('YOUR_TILESET_URL_HERE');
        viewer.scene.primitives.add(myTileset);
        viewer.zoomTo(myTileset);

        buildFilterUI();
        updateTilesetStyle();
        populateAutocompleteOptionsFromTileset();
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function updateTilesetStyle() {
        if (!myTileset) return;
        const filters = Object.entries(appState.filters)
            .filter(([_, v]) => v)
            .map(([k, v]) => {
                const prop = CONFIG.filterableProperties.find(p => p.propertyName === k);
                const expr = /^[a-zA-Z0-9_]+$/.test(k) ? `\${${k}}` : `getProperty('${k}')`;
                return prop.type === 'numeric' ? `${expr} === ${v}` : `${expr} === '${v}'`;
            });

        const show = filters.length ? filters.join(' && ') : 'true';
        const dateExpr = `{
            "expression": "const d = \${${CONFIG.date.propertyName}}; if(!d) return color('white'); const y = parseInt(d); return color('red').lerp(color('lime'), (y - ${CONFIG.date.min}) / ${CONFIG.date.max - CONFIG.date.min})"
        }`;

        let color = appState.colorizeByDate ? JSON.parse(dateExpr) : "color('white')";

        if (appState.searchQuery) {
            const val = appState.searchQuery;
            const cond = `(\${${CONFIG.search.PR1}} === '${val}' || \${${CONFIG.search.PR2}} === '${val}')`;
            if (typeof color === 'string') {
                color = `(${cond}) ? color('yellow') : ${color}`;
            } else {
                color.expression = `if (${cond}) return color('yellow'); else ${color.expression}`;
            }
        }

        myTileset.style = new Cesium.Cesium3DTileStyle({ show, color });
    }

    function buildFilterUI() {
        const container = document.getElementById('filter-container');
        container.innerHTML = '';

        CONFIG.filterableProperties.forEach(p => {
            const label = document.createElement('label');
            label.textContent = p.displayName;
            const input = document.createElement('input');
            input.id = `filter-${p.propertyName}`;
            input.placeholder = `Filter ${p.displayName}`;
            input.addEventListener('change', () => {
                appState.filters[p.propertyName] = input.value;
                updateTilesetStyle();
                zoomToMatchingFeature(p.propertyName, input.value);
            });

            if (p.type === 'numeric') {
                input.setAttribute('list', `datalist-${p.propertyName}`);
                const dl = document.createElement('datalist');
                dl.id = `datalist-${p.propertyName}`;
                container.appendChild(dl);
            }

            container.appendChild(label);
            container.appendChild(input);
        });
    }

    function populateAutocompleteOptionsFromTileset() {
        const seen = {};

        myTileset.tileVisible.addEventListener(tile => {
            const content = tile.content;
            for (let i = 0; i < content.featuresLength; i++) {
                const f = content.getFeature(i);
                CONFIG.filterableProperties
